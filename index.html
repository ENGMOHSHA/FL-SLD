<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BIRDEYE - Network Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.20.0/dist/cytoscape.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
/* === NO STYLE CHANGES === */
*{margin:0;padding:0;box-sizing:border-box;}
body{display:flex;height:100vh;font-family:'Segoe UI',sans-serif;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);overflow:hidden;}
#leftSection{display:none;flex-direction:column;gap:12px;padding:20px;
height:100vh;width:360px;position:fixed;top:0;left:0;
background:rgba(255,255,255,.98);z-index:1000;overflow-y:auto;}
#leftSection.show{display:flex;}
#burgerButton{position:fixed;top:20px;left:20px;z-index:2000;
background:white;width:45px;height:45px;border-radius:10px;
display:flex;align-items:center;justify-content:center;cursor:pointer;}
#cy{flex-grow:1;margin:20px 20px 20px 80px;background:white;border-radius:15px;}
#tooltip{position:fixed;display:none;background:rgba(0,0,0,.85);color:#fff;
padding:8px 10px;border-radius:8px;font-size:12px;pointer-events:none;}
</style>
</head>

<body>

<div id="burgerButton">â˜°</div>

<div id="leftSection">
  <div class="brand">ðŸ¦… BIRDEYE</div>
  <div class="dev-credit">Developed by Eng. Mohamad Shaban</div>
  <div id="status">Preparingâ€¦</div>

  <div class="panel-section">
    <div class="section-title">1) Project Selection</div>
    <select id="projectList">
      <option disabled selected>Select a Project...</option>
    </select>
    <div id="preloadStatus"></div>
  </div>

  <div class="panel-section">
    <div class="section-title">2) Filter by Grid Station</div>
    <input type="text" id="gridSearchInput" placeholder="Search grids...">
    <div>
      <input type="checkbox" id="selectAllGrids">
      <label for="selectAllGrids">Select All (visible)</label>
    </div>
    <div id="gridFilterContainer">
      <p id="emptyMsg">select project to load grids</p>
    </div>
    <button id="applyFilterBtn">Apply</button>
    <button id="resetFilterBtn">Reset</button>
  </div>

  <div class="panel-section">
    <div class="section-title">3) Feeder Search</div>
    <select id="gridForFeederSearch"></select>
    <select id="feederList"></select>
    <button id="searchFeederBtn">Search & Highlight</button>
  </div>

  <div class="panel-section">
    <button id="drawBtn" disabled>DRAW FL-SLD</button>
  </div>
</div>

<div id="cy"></div>
<div id="tooltip"></div>

<script>
/* =========================
   GLOBAL STATE (UNCHANGED)
========================= */
var cy=null;
var selectedGrids=[];
var activeProjectData={nodes:[],edges:[]};

/* =========================
   UTILITIES (UNCHANGED)
========================= */
function norm(v){return(v==null?'':(''+v)).replace(/\uFEFF/g,'').trim();}
function setStatus(t){var e=document.getElementById('status');if(e)e.innerText=t;}

/* =========================
   GRID FILTER (FIXED)
========================= */
function renderGridFilters(){
  var container=document.getElementById('gridFilterContainer');
  container.innerHTML='';
  if(!activeProjectData.nodes||activeProjectData.nodes.length<=1){
    container.innerHTML='<p>Select project to load grids</p>';
    return;
  }

  var map={};
  for(var i=1;i<activeProjectData.nodes.length;i++){
    var row=activeProjectData.nodes[i];
    if(!row) continue;
    var g=norm(row[4]);
    if(g) map[g]=true;
  }

  var grids=Object.keys(map).sort();
  if(grids.length===0){
    container.innerHTML='<p>No grids found</p>';
    return;
  }

  grids.forEach(function(grid){
    var d=document.createElement('div');
    d.innerHTML='<input type="checkbox" class="grid-chk" value="'+grid+'"> '+grid;
    container.appendChild(d);
  });
}

/* =========================
   FILTER HANDLERS (SAFE)
========================= */
function filterGridList(){
  var v=norm(document.getElementById('gridSearchInput').value).toLowerCase();
  document.querySelectorAll('.grid-chk').forEach(function(c){
    c.parentElement.style.display=
      c.value.toLowerCase().indexOf(v)!==-1?'block':'none';
  });
}

function applyFilter(){
  selectedGrids=[];
  document.querySelectorAll('.grid-chk:checked')
    .forEach(c=>selectedGrids.push(c.value));
  alert(selectedGrids.length
    ?('Filtering '+selectedGrids.length+' grids')
    :'No grid filter applied (showing all grids)');
}

function resetFilter(){
  selectedGrids=[];
  document.querySelectorAll('.grid-chk').forEach(c=>c.checked=false);
  document.getElementById('selectAllGrids').checked=false;
  document.getElementById('gridSearchInput').value='';
  filterGridList();
}

/* =========================
   GRAPH DRAW (UNCHANGED)
========================= */
function drawGraph(){
  if(!activeProjectData.nodes.length) return;
  var nodes=[],edges=[];
  for(var i=1;i<activeProjectData.nodes.length;i++){
    var r=activeProjectData.nodes[i];
    if(!r) continue;
    nodes.push({data:{
      id:norm(r[0]),
      label:norm(r[1]),
      grid:norm(r[4])
    }});
  }
  for(var j=1;j<activeProjectData.edges.length;j++){
    var e=activeProjectData.edges[j];
    if(!e) continue;
    edges.push({data:{id:e[0],source:e[1],target:e[2]}});
  }

  if(!cy){
    cy=cytoscape({
      container:document.getElementById('cy'),
      elements:{nodes:nodes,edges:edges},
      style:[{selector:'node',style:{label:'data(label)'}}]
    });
  }else{
    cy.elements().remove();
    cy.add(nodes.concat(edges));
  }
}

/* =========================
   EVENTS
========================= */
document.getElementById('gridSearchInput').addEventListener('input',filterGridList);
document.getElementById('applyFilterBtn').addEventListener('click',applyFilter);
document.getElementById('resetFilterBtn').addEventListener('click',resetFilter);
document.getElementById('drawBtn').addEventListener('click',drawGraph);
document.getElementById('burgerButton').onclick=function(){
  document.getElementById('leftSection').classList.toggle('show');
};
</script>

</body>
</html>
