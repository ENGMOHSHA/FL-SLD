<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BIRDEYE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.20.0/dist/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
/* ===== ORIGINAL SIMPLE LAYOUT (NO REDESIGN) ===== */
body{
  margin:0;
  font-family:Segoe UI, Arial;
  height:100vh;
  display:flex;
  background:#f0f0f0;
}

/* Burger */
#burgerButton{
  position:fixed;
  top:10px;
  left:10px;
  width:40px;
  height:40px;
  background:#fff;
  border:1px solid #ccc;
  cursor:pointer;
  z-index:1000;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* Left panel */
#leftSection{
  width:320px;
  background:#ffffff;
  border-right:1px solid #ccc;
  padding:10px;
  display:none;
  overflow:auto;
}
#leftSection.show{
  display:block;
}

.panel-section{
  margin-bottom:15px;
}
.section-title{
  font-weight:bold;
  margin-bottom:5px;
}

#cy{
  flex:1;
  height:100vh;
  background:#fff;
}

button, select, input{
  width:100%;
  margin-top:5px;
}
</style>
</head>

<body>

<div id="burgerButton">☰</div>

<div id="leftSection">

  <div class="panel-section">
    <div class="section-title">Project</div>
    <select id="projectList">
      <option disabled selected>Select project...</option>
    </select>
    <div id="status"></div>
  </div>

  <div class="panel-section">
    <div class="section-title">Grid Filter</div>
    <input id="gridSearchInput" placeholder="Search grid">
    <label>
      <input type="checkbox" id="selectAllGrids"> Select all
    </label>
    <div id="gridFilterContainer"></div>
    <button id="applyFilterBtn">Apply</button>
    <button id="resetFilterBtn">Reset</button>
  </div>

  <div class="panel-section">
    <button id="drawBtn" disabled>DRAW</button>
  </div>

</div>

<div id="cy"></div>

<script>
/* =====================================================
   GLOBAL STATE (UNCHANGED CONCEPT)
===================================================== */
var cy = null;
var activeProjectData = { nodes:[], edges:[] };
var selectedGrids = [];

/* =====================================================
   PROJECT CONFIG (EDIT PATHS ONLY)
===================================================== */
var PROJECTS = [
  {
    name: "Project A",
    nodes: "data/projectA_nodes.csv",
    edges: "data/projectA_edges.csv"
  }
];

/* =====================================================
   HELPERS
===================================================== */
function norm(v){
  return (v==null ? "" : String(v)).replace(/\uFEFF/g,"").trim();
}

function setStatus(t){
  document.getElementById("status").innerText = t;
}

/* =====================================================
   CSV HELPERS
===================================================== */
function fetchTextOrThrow(url){
  return fetch(url).then(function(r){
    if(!r.ok) throw new Error("Failed to load " + url);
    return r.text();
  });
}

function parseCSVToArray(txt){
  return Papa.parse(txt,{skipEmptyLines:true}).data;
}

/* =====================================================
   PROJECT LOADING
===================================================== */
function preloadProjects(){
  var sel = document.getElementById("projectList");
  PROJECTS.forEach(function(p){
    var o = document.createElement("option");
    o.value = p.name;
    o.text = p.name;
    sel.appendChild(o);
  });
}

function loadProjectByName(name){
  var p = PROJECTS.find(x=>x.name===name);
  if(!p){ alert("Project not found"); return; }

  setStatus("Loading CSV...");

  Promise.all([
    fetchTextOrThrow(p.nodes),
    fetchTextOrThrow(p.edges)
  ]).then(function(res){
    activeProjectData.nodes = parseCSVToArray(res[0]);
    activeProjectData.edges = parseCSVToArray(res[1]);

    renderGridFilters();
    document.getElementById("drawBtn").disabled = false;
    setStatus("Loaded: " + name);
  }).catch(function(e){
    alert(e.message);
  });
}

/* =====================================================
   GRID FILTER (FIXED – NO LOGIC CHANGE)
===================================================== */
function renderGridFilters(){
  var c = document.getElementById("gridFilterContainer");
  c.innerHTML = "";

  if(activeProjectData.nodes.length <= 1){
    c.innerHTML = "<p>No data</p>";
    return;
  }

  var map = {};
  for(var i=1;i<activeProjectData.nodes.length;i++){
    var row = activeProjectData.nodes[i];
    if(!row) continue;
    var g = norm(row[4]);
    if(g) map[g] = true;
  }

  Object.keys(map).sort().forEach(function(g){
    var d = document.createElement("div");
    d.innerHTML =
      '<label><input class="grid-chk" type="checkbox" value="'+g+'"> '+g+'</label>';
    c.appendChild(d);
  });
}

function filterGridList(){
  var v = norm(gridSearchInput.value).toLowerCase();
  document.querySelectorAll(".grid-chk").forEach(function(c){
    c.parentElement.style.display =
      c.value.toLowerCase().includes(v) ? "" : "none";
  });
}

function applyFilter(){
  selectedGrids = [];
  document.querySelectorAll(".grid-chk:checked")
    .forEach(c=>selectedGrids.push(c.value));
}

function resetFilter(){
  selectedGrids = [];
  document.querySelectorAll(".grid-chk").forEach(c=>c.checked=false);
}

/* =====================================================
   DRAW GRAPH (UNCHANGED CONCEPT)
===================================================== */
function drawGraph(){
  var nodes=[], edges=[];

  for(var i=1;i<activeProjectData.nodes.length;i++){
    var r = activeProjectData.nodes[i];
    if(!r) continue;

    if(selectedGrids.length && !selectedGrids.includes(norm(r[4]))) continue;

    nodes.push({
      data:{
        id:norm(r[0]),
        label:norm(r[1])
      }
    });
  }

  for(var j=1;j<activeProjectData.edges.length;j++){
    var e = activeProjectData.edges[j];
    if(!e) continue;
    edges.push({ data:{ source:e[1], target:e[2] }});
  }

  if(!cy){
    cy = cytoscape({
      container: document.getElementById("cy"),
      elements: nodes.concat(edges),
      style:[{ selector:"node", style:{ label:"data(label)" } }]
    });
  }else{
    cy.elements().remove();
    cy.add(nodes.concat(edges));
  }
}

/* =====================================================
   EVENTS
===================================================== */
burgerButton.onclick = function(){
  leftSection.classList.toggle("show");
};

gridSearchInput.oninput = filterGridList;
applyFilterBtn.onclick = applyFilter;
resetFilterBtn.onclick = resetFilter;
drawBtn.onclick = drawGraph;

projectList.onchange = function(){
  loadProjectByName(this.value);
};

document.addEventListener("DOMContentLoaded", preloadProjects);
</script>

</body>
</html>
